<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini‑Simulador de Tarifas — com Gráficos (v3c‑legend‑out)</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0b1220; --card:#111827;
    --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  }
  *{box-sizing:border-box}
  body{margin:0; padding:24px; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
       background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1220 35%, var(--bg) 70%);
       color:var(--text)}
  h1{margin:0 0 8px; font-size:clamp(20px,3vw,28px)}
  p.lead{margin:0 0 18px; color:var(--muted)}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(12,1fr)}
  .panel{grid-column:span 12; background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
         border:1px solid rgba(148,163,184,.18); border-radius:16px; padding:16px}
  @media(min-width:980px){
    .panel.left{grid-column:span 4}
    .panel.mid{grid-column:span 4}
    .panel.right{grid-column:span 4}
  }
  .section-title{font-size:14px; color:var(--accent); text-transform:uppercase; letter-spacing:.08em; margin:0 0 8px}
  .row{display:flex; align-items:center; gap:10px; margin:10px 0}
  .row label{flex:0 0 220px; color:var(--muted); font-size:14px}
  .row input[type=range]{flex:1}
  .row input[type=number]{width:110px; background:#0b1020; color: var(--text); border:1px solid rgba(148,163,184,.3);
                          border-radius:8px; padding:6px 8px}
  .switch{display:flex; align-items:center; gap:8px; margin-top:8px}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; letter-spacing:.02em;
        border:1px solid rgba(147,197,253,.35); color:#bfdbfe}
  .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  button{background:#0f1b31; color:#dbeafe; border:1px solid rgba(147,197,253,.35); padding:8px 12px; border-radius:10px;
         cursor:pointer}
  button:hover{background:#12203a}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th, td{padding:8px 10px; border-bottom:1px solid rgba(148,163,184,.2); text-align:right}
  th:first-child, td:first-child{text-align:left}
  .note{color:var(--muted); font-size:12px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
       background:#0d1326; border:1px solid rgba(148,163,184,.25); border-radius:6px; padding:1px 6px}
  canvas{background:#0c1324; border:1px solid rgba(148,163,184,.18); border-radius:12px; width:100%; height:auto}
  .small{font-size:12px; color:var(--muted)}
  .toolbar{display:flex; gap:8px; align-items:center; margin:8px 0}
  .legend{display:flex; align-items:center; gap:14px; margin:6px 0 8px 2px; font-size:12px; color:#cbd5e1}
  .legend .sw{display:inline-block; width:14px; height:10px; border-radius:3px; border:1px solid rgba(255,255,255,.25)}
  .legend .base{background:#334155}
  .legend .apos{background:#22d3ee}
</style>
</head>
<body>
  <h1>Mini‑Simulador de Tarifas</h1>
  <p class="lead">Gráficos compactos (520×360). <b>Frontloading</b>: barras de preço/quantidade/importações mostram o <u>ano</u> (H1+H2); <b>receita</b> e <b>DWL</b> refletem apenas o H2. O diagrama de Harberger usa a <u>base do H2</u> quando o frontloading está ativo.</p>

  <div class="grid">
    <!-- CONTROLES -->
    <section class="panel left">
      <div class="section-title">Parâmetros (base anual)</div>
      <div class="row"><label>Preço base P₀ (por unidade)</label><input type="number" id="P0" step="0.1" value="100"></div>
      <div class="row"><label>Quantidade base Q₀ (unidades)</label><input type="number" id="Q0" step="1" value="100"></div>
      <div class="row"><label>Participação de importados s (%)</label><input type="range" id="s" min="0" max="100" value="40" oninput="updateFromRange('s')"><input type="number" id="s_num" min="0" max="100" value="40" oninput="updateFromNumber('s')"></div>
      <div class="row"><label>Tarifa ad valorem τ (%)</label><input type="range" id="t" min="0" max="60" value="15" oninput="updateFromRange('t')"><input type="number" id="t_num" min="0" max="60" value="15" oninput="updateFromNumber('t')"></div>
      <div class="row"><label>Repasse da tarifa εₚ (0–1)</label><input type="range" id="ep" min="0" max="1" step="0.05" value="0.8" oninput="updateFromRange('ep')"><input type="number" id="ep_num" min="0" max="1" step="0.05" value="0.8" oninput="updateFromNumber('ep')"></div>
      <div class="row"><label>Elasticidade da demanda ε_d (negativa)</label><input type="range" id="ed" min="-2" max="0" step="0.05" value="-0.5" oninput="updateFromRange('ed')"><input type="number" id="ed_num" min="-2" max="0" step="0.05" value="-0.5" oninput="updateFromNumber('ed')"></div>

      <div class="section-title" style="margin-top:14px;">Frontloading (opcional)</div>
      <div class="switch"><input type="checkbox" id="flToggle" onchange="recalc()"><label for="flToggle">Simular frontloading</label></div>
      <div class="row"><label>Percentual antecipado φ (% do ano para H1)</label><input type="range" id="phi" min="0" max="30" value="10" oninput="updateFromRange('phi')"><input type="number" id="phi_num" min="0" max="30" value="10" oninput="updateFromNumber('phi')"></div>

      <div class="btns"><button onclick="presetTariff(0)">τ = 0%</button><button onclick="presetTariff(15)">τ = 15%</button><button onclick="presetTariff(45)">τ = 45% (EVs UE)</button></div>
      <div class="toolbar"><button onclick="resetScales()">Resetar escalas</button></div>
      <p class="small">Dica: varie <b>εₚ</b> e <b>ε_d</b> para ver o triângulo mudar.</p>
    </section>

    <!-- BARRAS -->
    <section class="panel mid">
      <div class="section-title">Gráfico de Barras — Principais Resultados</div>
      <div class="legend"><span class="sw base"></span><span>Base</span> <span class="sw apos"></span><span>Após</span></div>
      <canvas id="barChart" width="520" height="360"></canvas>
      <p class="small">Para Receita e DWL, a base é 0.</p>
    </section>

    <!-- HARBERGER -->
    <section class="panel right">
      <div class="section-title">Diagrama — Triângulo de Harberger</div>
      <canvas id="sdChart" width="520" height="360"></canvas>
      <p class="small">Se o frontloading estiver ativo, H2 é a base do diagrama.</p>
    </section>

    <!-- TABELA -->
    <section class="panel" style="grid-column:span 12">
      <div class="section-title">Resultados numéricos</div>
      <table id="results"><thead><tr><th>Métrica</th><th>Valor</th><th>Comentário</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

<script>
  function $(id){ return document.getElementById(id); }
  function num(v){ return parseFloat(v); }

  const scales = { bars: {Preco:0, Quant:0, Import:0, Receita:0, DWL:0}, sd: null };
  function resetScales(){ scales.bars = {Preco:0, Quant:0, Import:0, Receita:0, DWL:0}; scales.sd = null; recalc(); }

  function updateFromRange(key){ $(key + '_num').value = $(key).value; recalc(); }
  function updateFromNumber(key){ $(key).value = $(key + '_num').value; recalc(); }
  function presetTariff(val){ $('t').value = val; $('t_num').value = val; recalc(); }

  function formatPct(x){ return (x*100).toFixed(2) + '%'; }
  function formatPct1(x){ return (x*100).toFixed(1) + '%'; }
  function money(x){ return 'R$ ' + x.toFixed(2); }

  function recalc(){
    const P0 = num($('P0').value), Q0 = num($('Q0').value);
    const s  = num($('s').value)/100.0, t  = num($('t').value)/100.0;
    const ep = num($('ep').value), ed = num($('ed').value);

    const dPpct = s * ep * t;
    const P1_inst = P0 * (1 + dPpct);
    const dQ_inst = ed * dPpct * Q0;
    const Q1_inst = Math.max(0, Q0 + dQ_inst);
    const Qimp0_inst = s * Q0;
    const Qimp1_inst = Math.max(0, Qimp0_inst + ed * (ep * t) * Qimp0_inst);
    const revenue_inst = t * P0 * Qimp1_inst;
    const DWL_inst = 0.5 * Math.abs(ed) * Math.pow(dPpct,2) * P0 * Q0;

    // Annual/H2 values with optional frontloading
    let P_disp = P1_inst, Q_disp = Q1_inst, Qimp_disp = Qimp1_inst, Qimp_base_disp = Qimp0_inst;
    let revenue_disp = revenue_inst, DWL_disp = DWL_inst;
    let Q0_plot = Q0, Q1_plot = Q1_inst, Qimp_plot = Qimp1_inst; // for Harberger

    if($('flToggle').checked){
      const phi = num($('phi').value)/100.0;
      const Q_H1 = Q0*(0.5 + phi), P_H1 = P0, imp_H1 = s * Q_H1;
      const Q_base_H2 = Q0*(0.5 - phi);
      const dQ_H2 = ed * dPpct * Q_base_H2;
      const Q_H2 = Math.max(0, Q_base_H2 + dQ_H2);
      const P_H2 = P1_inst;
      const imp_H2_0 = s * Q_H2;
      const imp_H2_1 = Math.max(0, imp_H2_0 + ed * (ep * t) * imp_H2_0);

      const Q_year = Q_H1 + Q_H2;
      const P_avg = (P_H1*Q_H1 + P_H2*Q_H2) / Math.max(1e-9, Q_year);
      const imp_year_after = imp_H1 + imp_H2_1;
      const imp_year_base  = s * Q0;

      P_disp = P_avg; Q_disp = Q_year; Qimp_disp = imp_year_after; Qimp_base_disp = imp_year_base;
      revenue_disp = t * P0 * imp_H2_1;
      DWL_disp = 0.5 * Math.abs(ed) * Math.pow(dPpct,2) * P0 * Q_base_H2;

      Q0_plot = Q_base_H2; Q1_plot = Q_H2; Qimp_plot = imp_H2_1;
    }

    // Update table
    const rows = [
      ['Preço médio', money(P_disp), `ΔP ≈ ${formatPct1((P_disp/P0)-1)}`],
      ['Quantidade total', Q_disp.toFixed(2), `ΔQ ≈ ${formatPct((Q_disp/Q0)-1)}`],
      ['Importações (ano, após)', Qimp_disp.toFixed(2), `base: ${Qimp_base_disp.toFixed(2)}`],
      ['Receita tarifária (H2)', money(revenue_disp), `τ · P₀ · imports(H2)`],
      ['Perda de bem‑estar (H2, ≈)', money(DWL_disp), 'triângulo de Harberger']
    ];
    const tbody = document.querySelector('#results tbody');
    tbody.innerHTML = rows.map(r => `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('');

    drawBars({P0, P1:P_disp, Q0, Q1:Q_disp, Qimp0:Qimp_base_disp, Qimp1:Qimp_disp, revenue:revenue_disp, dwl:DWL_disp});
    drawHarberger({P0, Q0_plot:Q0_plot, Q1_plot:Q1_plot, dPpct, t, Qimp:Qimp_plot, ed});
  }

  function drawBars(data){
    const c = $('barChart'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const pad = 30, W = c.width - pad*2, H = c.height - pad*2;
    const x0 = pad, y0 = pad;

    // Persistent maxima
    scales.bars.Preco   = Math.max(scales.bars.Preco, data.P0, data.P1, 1);
    scales.bars.Quant   = Math.max(scales.bars.Quant, data.Q0, data.Q1, 1);
    scales.bars.Import  = Math.max(scales.bars.Import, data.Qimp0, data.Qimp1, 1);
    scales.bars.Receita = Math.max(scales.bars.Receita, data.revenue, 1);
    scales.bars.DWL     = Math.max(scales.bars.DWL, data.dwl, 1);

    const groups = [
      {label:'Preço', key:'Preco', a:data.P0, b:data.P1, fmt:(v)=>'R$ '+v.toFixed(2)},
      {label:'Quantidade', key:'Quant', a:data.Q0, b:data.Q1, fmt:(v)=>v.toFixed(2)},
      {label:'Importações', key:'Import', a:data.Qimp0, b:data.Qimp1, fmt:(v)=>v.toFixed(2)},
      {label:'Receita (H2)', key:'Receita', a:0, b:data.revenue, fmt:(v)=>'R$ '+v.toFixed(2)},
      {label:'DWL (H2)', key:'DWL', a:0, b:data.dwl, fmt:(v)=>'R$ '+v.toFixed(2)}
    ];

    const barW = W / (groups.length*3);
    const gap = barW;
    let x = x0 + gap/2;

    ctx.font = '12px system-ui';
    ctx.fillStyle = '#9aa7b3';
    ctx.textAlign = 'center';

    // axis
    ctx.strokeStyle = 'rgba(148,163,184,.5)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x0, y0+H); ctx.lineTo(x0+W, y0+H); ctx.stroke();

    const minLabelY = y0 + 14;

    groups.forEach((g)=>{
      const maxv = Math.max(scales.bars[g.key], 1);
      const hA = H * (g.a / maxv);
      const hB = H * (g.b / maxv);

      // Base bar
      ctx.fillStyle = '#334155';
      ctx.fillRect(x, y0+H - hA, barW, hA);
      let ya = y0+H - hA - 6; if (ya < minLabelY) ya = minLabelY;
      ctx.fillStyle = '#cbd5e1'; ctx.fillText(g.fmt(g.a), x + barW/2, ya);

      // After bar
      ctx.fillStyle = '#22d3ee';
      ctx.fillRect(x+barW+4, y0+H - hB, barW, hB);
      let yb = y0+H - hB - 6; if (yb < minLabelY) yb = minLabelY + 12;
      ctx.fillStyle = '#e0f2fe'; ctx.fillText(g.fmt(g.b), x + barW + 4 + barW/2, yb);

      // Group label (tight above axis, inside canvas)
      ctx.fillStyle = '#cbd5e1';
      ctx.fillText(g.label, x+barW*1.5+2, y0+H - 4);

      x += barW*2 + gap + 4;
    });

    // Legend moved outside canvas (HTML above the canvas)
  }

  function drawHarberger({P0, Q0_plot, Q1_plot, dPpct, t, Qimp, ed}){
    const c = $('sdChart'), ctx = c.getContext('2d');
    ctx.clearRect(0,0,c.width,c.height);
    const padL=48, padB=36, padT=16, padR=16;
    const W = c.width - padL - padR, H = c.height - padT - padB;
    const originX = padL, originY = padT + H;

    const b = (P0) / (Math.abs(ed) * Math.max(1e-9, Q0_plot));
    const a = P0 + b*Q0_plot;
    const P1 = P0 * (1 + dPpct);

    if(!scales.sd){
      const Pmax0 = Math.max(a*1.05, P1*1.25, P0*1.25);
      const Qmax0 = Math.max(Q0_plot, Q1_plot, Qimp)*1.6 + 1;
      scales.sd = {Pmax:Pmax0, Qmax:Qmax0};
    }
    const {Pmax, Qmax} = scales.sd;
    const xScale = q => originX + (q/Qmax)*W;
    const yScale = p => originY - (p/Pmax)*H;

    ctx.strokeStyle = 'rgba(148,163,184,.5)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(originX, padT); ctx.lineTo(originX, originY); ctx.lineTo(originX+W, originY); ctx.stroke();
    ctx.font='12px system-ui'; ctx.fillStyle='#9aa7b3';
    ctx.fillText('Q', originX+W-8, originY+20);
    ctx.fillText('P', originX-20, padT+8);

    ctx.strokeStyle = '#60a5fa'; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(xScale(0), yScale(a)); ctx.lineTo(xScale(Qmax), yScale(a - b*Qmax)); ctx.stroke();
    ctx.fillStyle='#cbd5e1'; ctx.fillText('Demanda (H2 se FL)', xScale(Qmax*0.45), yScale(a - b*Qmax*0.45)-6);

    drawPoint(ctx, xScale(Q0_plot), yScale(P0), '#34d399', 'E₀');
    drawPoint(ctx, xScale(Q1_plot), yScale(P1), '#22d3ee', 'E₁');

    const taxPerUnit = t * P0;
    const rectX = xScale(0);
    const rectY = yScale(P0 + taxPerUnit);
    const rectW = xScale(Qimp) - xScale(0);
    const rectH = yScale(P0) - yScale(P0 + taxPerUnit);
    ctx.fillStyle = 'rgba(34,211,238,0.25)';
    ctx.strokeStyle = 'rgba(34,211,238,0.8)'; ctx.lineWidth=1.5;
    ctx.fillRect(rectX, rectY, rectW, rectH); ctx.strokeRect(rectX, rectY, rectW, rectH);
    ctx.fillStyle='#93c5fd'; ctx.fillText('Receita tarifária', rectX+6, rectY-6);

    ctx.fillStyle = 'rgba(248,113,113,0.28)'; ctx.strokeStyle = 'rgba(248,113,113,0.9)';
    ctx.beginPath(); ctx.moveTo(xScale(Q1_plot), yScale(P1)); ctx.lineTo(xScale(Q0_plot), yScale(P1)); ctx.lineTo(xScale(Q0_plot), yScale(P0)); ctx.closePath();
    ctx.fill(); ctx.stroke();
    ctx.fillStyle='#fecaca'; ctx.fillText('DWL', xScale(Q0_plot)+6, (yScale(P1)+yScale(P0))/2);

    ctx.setLineDash([5,4]); ctx.strokeStyle='rgba(148,163,184,.5)';
    ctx.beginPath(); ctx.moveTo(xScale(0), yScale(P0)); ctx.lineTo(xScale(Qmax), yScale(P0)); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(xScale(0), yScale(P1)); ctx.lineTo(xScale(Qmax), yScale(P1)); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(xScale(Q0_plot), yScale(0)); ctx.lineTo(xScale(Q0_plot), yScale(Pmax)); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(xScale(Q1_plot), yScale(0)); ctx.lineTo(xScale(Q1_plot), yScale(Pmax)); ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle='#9aa7b3';
    ctx.fillText('P₀', xScale(0)-20, yScale(P0)+4);
    ctx.fillText('P₁', xScale(0)-20, yScale(P1)+4);
    ctx.fillText('Q₀', xScale(Q0_plot)-6, originY+16);
    ctx.fillText('Q₁', xScale(Q1_plot)-6, originY+16);
  }

  function drawPoint(ctx, x, y, color, label){
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='#e5e7eb'; ctx.font='12px system-ui'; ctx.fillText(label, x+6, y-8);
  }

  recalc();
</script>
</body>
</html>
